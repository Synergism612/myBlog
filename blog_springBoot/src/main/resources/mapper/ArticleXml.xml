<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.synergism.blog.core.article.mapper.ArticleMapper">

    <resultMap id="ArticleInformationMap" type="com.synergism.blog.core.article.entity.ArticleInformation">
        <id column="id" property="id"/>
        <result column="icon" property="icon"/>
        <result column="title" property="title"/>
        <result column="body" property="body"/>
        <result column="synopsis" property="synopsis"/>
        <result column="views" property="views"/>
        <result column="like_count" property="likeCount"/>
        <result column="creation_time" property="creationTime"/>
        <result column="modify_time" property="modifyTime"/>
        <result column="if_private" property="ifPrivate"/>
        <result column="nickname" property="nickname"/>
        <result column="username" property="username"/>
        <result column="comment_count" property="commentCount"/>


        <collection property="classify" ofType="com.synergism.blog.core.classify.entity.Classify">
            <id column="classify_id" property="id"/>
            <result column="classify_name" property="name"/>
            <result column="classify_annotation" property="annotation"/>
        </collection>

        <collection property="tagList" ofType="com.synergism.blog.core.tag.entity.Tag">
            <id column="tag_id" property="id"/>
            <result column="tag_name" property="name"/>
            <result column="tag_annotation" property="annotation"/>
        </collection>
    </resultMap>

    <select id="selectAllArticleInformationList" resultMap="ArticleInformationMap">
        select a.id,
               a.icon,
               a.title,
               a.body,
               a.synopsis,
               a.views,
               a.like_count,
               a.creation_time,
               a.modify_time,
               a.if_private,
               u.nickname,
               u.username,
               cy.id         as classify_id,
               cy.name       as classify_name,
               cy.annotation as classify_annotation,
               t.id          as tag_id,
               t.name        as tag_name,
               t.annotation  as tag_annotation,
               count(ac.id)  as comment_count
        from user_article ua
                 join(
            `user` u ,
                article a ,
                article_classify acy ,
                classify cy ,
                article_tag atg ,
                tag t,
                article_comment ac
            )
                     on
                             ua.user_id = u.id
                             and
                             ua.article_id = a.id
                             and
                             acy.article_id = a.id
                             and
                             cy.id = acy.classify_id
                             and
                             atg.article_id = a.id
                             and
                             t.id = atg.tag_id
                             and
                             ac.article_id = a.id
        group by a.id,
                 a.icon,
                 a.title,
                 a.body,
                 a.synopsis,
                 a.views,
                 a.like_count,
                 a.creation_time,
                 a.modify_time,
                 a.if_private,
                 u.nickname,
                 u.username,
                 cy.id,
                 cy.name,
                 cy.annotation,
                 t.id,
                 t.name,
                 t.annotation
    </select>
    <select id="selectOneClassifyArticleList" resultType="com.synergism.blog.core.article.entity.Article">
        select a.id,
               a.icon,
               a.title,
               a.body,
               a.synopsis,
               a.views,
               a.like_count,
               a.creation_time,
               a.modify_time
        from article_classify ac1
                 join
             (article_classify ac2,
                 article a)
             on
                     ac1.classify_id = ac2.classify_id and
                     ac2.article_id = a.id
        where ac1.article_id != ac2.article_id
          and ac1.article_id = #{id}
    </select>
    <select id="selectMoreTagArticleList" resultType="com.synergism.blog.core.article.entity.ArticleTagNominate">
        select count(atg1.tag_id) tagCount,
               a.id,
               a.icon,
               a.title,
               a.body,
               a.synopsis,
               a.views,
               a.like_count,
               a.creation_time,
               a.modify_time
        from article_tag atg1
                 join
             (article_tag atg2 ,
                 article a
                 )
             on
                     atg1.tag_id = atg2.tag_id and
                     atg2.article_id = a.id
        where atg1.article_id != atg2.article_id
          and atg1.article_id = #{id}
        group by atg1.article_id,
                 atg2.article_id
    </select>

</mapper>

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.synergism.blog.core.repository.mapper.RepositoryMapper">

    <resultMap id="RepositoryInformationMap" type="com.synergism.blog.core.repository.entity.RepositoryInformation">
        <result column="id" property="id"/>
        <result column="path" property="path"/>
        <result column="size" property="size"/>
        <result column="used" property="used"/>
        <result column="creation_time" property="creationTime"/>
        <result column="modify_time" property="modifyTime"/>
        <result column="username" property="username"/>
        <collection property="folderList" ofType="com.synergism.blog.core.repository.entity.Folder">
            <result column="folder_id" property="id"/>
            <result column="folder_path" property="path"/>
            <result column="folder_name" property="name"/>
        </collection>
        <collection property="fileList" ofType="com.synergism.blog.core.repository.entity.File">
            <result column="file_id" property="id"/>
            <result column="file_name" property="name"/>
            <result column="file_suffix" property="suffix"/>
            <result column="file_type" property="type"/>
            <result column="file_size" property="size"/>
            <result column="file_path" property="path"/>
            <result column="file_href" property="href"/>
        </collection>
    </resultMap>

    <insert id="bundle">
        INSERT INTO user_repository(user_id, repository_id)
        values (#{userID}, #{repositoryID});
    </insert>
    <select id="selectRepositoryInformationByUsername" resultMap="RepositoryInformationMap">
        select r.id,
               r.`path`,
               r.`size`,
               r.used,
               r.creation_time,
               r.modify_time,
               u.username,
               fr.id     as folder_id,
               fr.`path` as folder_path,
               fr.name   as folder_name,
               fe.id     as file_id,
               fe.name   as file_name,
               fe.suffix as file_suffix,
               fe.`type` as file_type,
               fe.`size` as file_size,
               fe.`path` as file_path,
               fe.href   as file_href
        from user_repository ur
                 join
             (
                 `user` u ,
                     repository r,
                     repository_folder rfr,
                     folder fr,
                     repository_file rfe,
                     file fe)
             on
                     u.id = ur.user_id and
                     r.id = ur.repository_id and
                     rfr.repository_id = r.id and
                     fr.id = rfr.folder_id and
                     rfe.repository_id = r.id and
                     fe.id = rfe.id
        where fr.parent_id is null
          and u.username = #{username}
    </select>
</mapper>
